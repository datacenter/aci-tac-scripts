# SMU Pre-upgrade Validation

## Getting started

This script validates Cisco ACI switches against known SMU issues.

@ Author: joelebla@cisco.com


## What is checked ?

1. Ensure correct image type (32-bit or 64-bit) based on switch memory capacity (CSCwj44966)
2. Ensure .repodata file does not exist (CSCwo34637)

## How to use it?

Copy the script to any of the APICs using vim 

```
vim smu-pre-upgrade-validation.py
```

- Type `i` to enter INSERT mode
- Paste the script
- Exit and save vim using ESC key, type `:wq` and ENTER

Add the execute permission to the file

```
chmod u+x smu-pre-upgrade-validation.py
```

Execute the script 

```
python smu-pre-upgrade-validation.py {args}
```

### Running in Interactive Mode

When running in Interactive Mode, the script will prompt for a username and password

```apic1# python smu-pre-upgrade-validation.py 
======================================================
 ACI Switch SMU Pre-upgrade Validation Script
 2025-05-01 20:56:06.786482
======================================================

Please enter your credentials:
Username: joe
Password for joe: 

Getting APIC management address...
Using APIC management address: 10.0.0.1
Verifying credentials against APIC (10.0.0.1)...
Successfully authenticated to APIC
Determining APIC version and MD5 hashes...
APIC version: 6.0(5h)
32-bit image MD5: 95d1a7f9bf12b0cf4d2372dbc7beed3a
64-bit image MD5: 94fd7711193f0b1ebd50606d464b2beb
Retrieving switch information...
Found 10 switches and 0 modular spine switches.
Starting data collection in parallel...

Stage: Complete!
[##################################################] 100% | Processed: 10 of 10 | Time: 00:33


======================================================
 Script execution complete
 Results saved to smu-check-results-2025-05-01_2056.txt

 MD5 Check Results:
 PASS   : 9 switches
 FAIL   : 0 switches
 WARNING: 0 switches
 ERROR  : 1 switches

 Repodata Check Results:
 PASS     : 9 switches
 FAIL     : 1 switches
 ERROR    : 0 switches

 Runtime Statistics:
 Total Execution Time: 00:33
 Avg Time Per Switch : 00:03
======================================================
```

#### Optional arguments

```apic1# python smu-pre-upgrade-validation.py -h
usage: smu-pre-upgrade-validation.py [-h] [--json FILENAME] [--username USERNAME] [--password PASSWORD]

ACI Switch SMU Pre-upgrade Validation Script

optional arguments:
  -h, --help           show this help message and exit
  --json FILENAME      Export results to JSON file
  --username USERNAME  Username for non-interactive mode
  --password PASSWORD  Password for non-interactive mode
```

### Files created

In the below example,
- json-output is a JSON file created when using the flags --json json-output
- logs is the directory where the script debug logs are stored
- smu-check-results-2025-05-01_2056.txt is the detailed report file generated by the script
- smu-pre-upgrade-validation.py is the script file
- smu-check-debug.log is the file generated in the logs directory where the debug logs are stored

```apic1# ls -lh
total 240K
-rw------- 1 joe admin 5.7K May  1 17:19 json-output
drwx------ 2 joe admin 4.0K May  1 04:37 logs
-rw-r--r-- 1 joe admin 4.9K May  1 20:56 smu-check-results-2025-05-01_2056.txt
-rw------- 1 joe admin 124K May  1 19:23 smu-pre-upgrade-validation.py

apic1# ls -lh logs
total 312K
-rw------- 1 joe admin 307K May  1 20:56 smu-check-debug.log
```

## Example script output

```apic1# cat smu-check-results-2025-05-01_2056.txt
======================================================
 ACI Switch SMU Pre-upgrade Validation Report
 Generated on 2025-05-01 20:56:06.786543
======================================================

Getting APIC management address...
Using APIC management address: 10.0.0.1
Determining APIC version and MD5 hashes...
APIC version: 6.0(5h)
32-bit image MD5: 95d1a7f9bf12b0cf4d2372dbc7beed3a
64-bit image MD5: 94fd7711193f0b1ebd50606d464b2beb
Retrieving switch information...
Found 10 switches and 0 modular spine switches.
Starting data collection in parallel...

Switch: leaf-1001 (10.0.8.64)
Memory: 24419328 KB
Image: /bootflash/aci-n9000-dk9.16.0.5h.bin
MD5sum: None

Results:
MD5sum Check   : ERROR Could not retrieve MD5 information
Repodata Check : PASS (.repodata file not present)

Recommendations:
Re-run the script from the admin account to rectify the permissions issue.

Note: Rectification of permissions will only work from the admin account.
It will not work even if a non-admin user belongs to the admin group.

Diagnostics:
md5sum: /bootflash/aci-n9000-dk9.16.0.5h.bin: Permission denied
----------------------------------------

Switch: spine-202 (10.112.40.65)
Memory: 32533504 KB
Image: /bootflash/aci-n9000-dk9.16.0.5h-cs_64.bin
MD5sum: 94fd7711193f0b1ebd50606d464b2beb

Results:
MD5sum Check   : PASS Running 64bit image with 32GB memory or greater
Repodata Check : PASS (.repodata file not present)
----------------------------------------

Switch: leaf-2001 (10.112.168.65)
Memory: 24419328 KB
Image: /bootflash/aci-n9000-dk9.16.0.5h.bin
MD5sum: 95d1a7f9bf12b0cf4d2372dbc7beed3a

Results:
MD5sum Check   : PASS Running 32bit image with less than 32GB memory
Repodata Check : PASS (.repodata file not present)
----------------------------------------

Switch: spine-201 (10.112.168.64)
Memory: 16186368 KB
Image: /bootflash/aci-n9000-dk9.16.0.5h.bin
MD5sum: 95d1a7f9bf12b0cf4d2372dbc7beed3a

Results:
MD5sum Check   : PASS Running 32bit image with less than 32GB memory
Repodata Check : PASS (.repodata file not present)
----------------------------------------

Switch: leaf-1004 (10.0.160.64)
Memory: 24419328 KB
Image: /bootflash/aci-n9000-dk9.16.0.5h.bin
MD5sum: 95d1a7f9bf12b0cf4d2372dbc7beed3a

Results:
MD5sum Check   : PASS Running 32bit image with less than 32GB memory
Repodata Check : PASS (.repodata file not present)
----------------------------------------

Switch: spine-101 (10.0.8.65)
Memory: 16186368 KB
Image: /bootflash/aci-n9000-dk9.16.0.5h.bin
MD5sum: 95d1a7f9bf12b0cf4d2372dbc7beed3a

Results:
MD5sum Check   : PASS Running 32bit image with less than 32GB memory
Repodata Check : PASS (.repodata file not present)
----------------------------------------

Switch: leaf-1002 (10.0.8.67)
Memory: 24419328 KB
Image: /bootflash/aci-n9000-dk9.16.0.5h.bin
MD5sum: 95d1a7f9bf12b0cf4d2372dbc7beed3a

Results:
MD5sum Check   : PASS Running 32bit image with less than 32GB memory
Repodata Check : FAIL (.repodata directory exists)

Recommendations:
Contact Cisco TAC to remove .repodata file via root user.

Defect Reference:
https://bst.cloudapps.cisco.com/bugsearch/bug/CSCwo34637
----------------------------------------

Switch: leaf-2002 (10.112.40.64)
Memory: 24419328 KB
Image: /bootflash/aci-n9000-dk9.16.0.5h.bin
MD5sum: 95d1a7f9bf12b0cf4d2372dbc7beed3a

Results:
MD5sum Check   : PASS Running 32bit image with less than 32GB memory
Repodata Check : PASS (.repodata file not present)
----------------------------------------

Switch: spine-102 (10.0.8.66)
Memory: 16186368 KB
Image: /bootflash/aci-n9000-dk9.16.0.5h.bin
MD5sum: 95d1a7f9bf12b0cf4d2372dbc7beed3a

Results:
MD5sum Check   : PASS Running 32bit image with less than 32GB memory
Repodata Check : PASS (.repodata file not present)
----------------------------------------

Switch: leaf-1003 (10.0.8.96)
Memory: 24419328 KB
Image: /bootflash/aci-n9000-dk9.16.0.5h.bin
MD5sum: 95d1a7f9bf12b0cf4d2372dbc7beed3a

Results:
MD5sum Check   : PASS Running 32bit image with less than 32GB memory
Repodata Check : PASS (.repodata file not present)
----------------------------------------

======================================================
 Script execution complete
 Results saved to smu-check-results-2025-05-01_2056.txt

 MD5 Check Results:
 PASS   : 9 switches
 FAIL   : 0 switches
 WARNING: 0 switches
 ERROR  : 1 switches

 Repodata Check Results:
 PASS     : 9 switches
 FAIL     : 1 switches
 ERROR    : 0 switches

 Runtime Statistics:
 Total Execution Time: 00:33
 Avg Time Per Switch : 00:03
======================================================
```
